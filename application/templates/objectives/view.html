{% extends "objectives/base.html" %}

{% from '_macros.html' import render_field, render_hidden %}

{% block inside_banner %}
{%- if user -%}<span class="user_indicator--manager">manager view</span>{%- endif -%}
{% endblock %}

{% block main_content %}

  <section class="objective_container">
    <header class="note_header">

      {%- if not user -%}
      <div class="note_actions">
        <ul>
          <li><a href="{{ url_for('objectives.edit', id=objective.id) }}">edit</a></li>
          <li><a href="">delete</a></li>
          <li><a href="">share</a></li>
        </ul>
      </div>
      {%- endif -%}

      <h1 class="heading-large note_title">
        {%- if user -%}<span class="heading-secondary">{{ user.full_name }}'s Objectives</span>{%- endif -%}
        {{ objective.entry.title|default("Objective") }}
      </h1>

      {% if objective.entry.last_updated is defined %}
        {% if objective.entry.last_updated != None %}
        <span class="note_date">Last edited on {{ "{:%a %d %b %y %p}".format(objective.entry.last_updated) }}</span>
        {% endif %}
      {% endif %}

    </header>

    <section class="item-view_body">
      <h3 class="heading-small">What</h3>
      <div>{{ objective.entry.what|markdown }}</div>

      <h3 class="heading-small">How</h3>
      <div class="rendered-markdown">{{ objective.entry.how|markdown }}</div>

    <h3 class="heading-small">Progress</h3>
    <div class="rendered-markdown">{{ objective.entry.progress|default('')|markdown }}</div>
  </section>

    <section class="obj_attachments">
      <header class="obj_attachments_head">
        {% if not user %}
        <a class="evidence-add-link evidence-add-link--right" href="{{ url_for('objectives.add_evidence', id=objective.id) }}">+ add evidence</a>
        {% endif %}
        <h3 class="heading-small">Evidence</h3>
      </header>

      {% if evidence_form %}
      <div class="evidence_add">
        <h3 class="heading-small">Attach evidence</h3>
        <form class="evidence_form" method="post" action="{{ url_for('objectives.add_evidence', id=objective.id) }}">
          {{ render_hidden(evidence_form) }}

          {{ render_field(evidence_form.title) }}

          {{ render_field(evidence_form.content, rows=4) }}

          <button class="button">Attach evidence</button>
        </form>
      </div>
      {% endif %}

      {% if objective.evidence|length > 0 %}
        <ul class="evidence_list">
        {% for item in objective.evidence %}
          <li class="evidence_item">
            <details>
              <summary class="evidence_summary">
                <span class="evidence_title">{{ item.entry.title }}</span>
                <span class="evidence_date">added on {{ "{:%Y-%m-%d %H:%M}".format(item.created_date) }}</span>
                {% if not user %}
                <span class="evidence_remove remove-link"><a href="{{ url_for('objectives.remove_evidence', id=objective.id, evidence_id=item.id) }}">remove</a></span>
                {% endif %}
              </summary>
              <div class="panel-indent evidence_content">{{ item.entry.content|markdown }}</div>
            </details>
          </li>
        {% endfor %}
        </ul>
      {% else %}
        <p class="comment__none">No evidence attached</p>
      {% endif %}
    </section>
  </section><!-- end objective_container -->

  <section class="obj_comments">
    <h3 class="heading-medium">Comments</h3>
    {% if objective.comments|length > 0 %}
      {% for comment in objective.comments|sort(true,attribute='created_date') %}
      <div class="comment">
        <dl class="comment__metadata definition-inline">
          <dt class="visuallyhidden">From</dt><dd>{{ comment.owner.full_name }}</dd>
          <dt>Date</dt><dd>{{ '{:%Y-%m-%d %H:%M:%S}'.format(comment.created_date) }}</dd>
        </dl>
        <div class="comment__content">
          {{ comment.entry.content }}
        </div>
      </div>
      {% endfor %}
    {% else %}
    <p class="comment__none">No comments yet</p>
    {% endif %}

    {%- if user -%}
    <form class="comment_form" method="post" action="{{ request.path }}/comment">
      <textarea placeholder="enter comment here" class="form-control comment_content_entry" name="content"></textarea>
      <button class="comment_button">Comment</button>
    </form>
    {% endif %}
  </section>

{% endblock %}
